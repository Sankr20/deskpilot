#!/usr/bin/env bash
set -euo pipefail
ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROPS="$ROOT/deskpilot.properties"

if [[ ! -f "$PROPS" ]]; then
  echo "[ERROR] deskpilot.properties not found in $ROOT" >&2
  exit 2
fi

DP_VER="$(grep '^deskpilot.version=' "$PROPS" | head -n1 | cut -d= -f2- | tr -d '\r')"
if [[ -z "${DP_VER}" ]]; then
  echo "[ERROR] deskpilot.version missing in deskpilot.properties" >&2
  exit 2
fi

CACHE="$ROOT/.deskpilot/cli/$DP_VER"
JAR="$CACHE/deskpilot.jar"
mkdir -p "$CACHE"

if [[ ! -f "$JAR" ]]; then
  echo "[INFO] CLI jar not found at: $JAR" >&2
  echo "[INFO] For now, copy deskpilot.jar there. (Next step: auto-download via JitPack)" >&2
  exit 2
fi

exec java -jar "$JAR" "$@"
